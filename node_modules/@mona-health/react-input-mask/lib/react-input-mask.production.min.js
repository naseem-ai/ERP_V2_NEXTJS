"use strict";var e=require("react");require("prop-types");var t=require("invariant");function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},n.apply(this,arguments)}function i(e){return requestAnimationFrame(e)}function r(e){cancelAnimationFrame(e)}function a(e){var t=e.ownerDocument;return t.hasFocus()&&t.activeElement===e}function l(e){return null==e?void 0:e.ownerDocument}function o(e){var t=function(e){var t;return null==(t=l(e))?void 0:t.defaultView}(e);return!!t&&e instanceof t.HTMLElement}function u(t){return e.useCallback((function(){var e=t.current,n="undefined"!=typeof window&&o(e);if(!e||!n)return null;if("INPUT"!==e.nodeName&&(e=e.querySelector("input")),!e)throw new Error("react-input-mask: inputComponent doesn't contain input node");return e}),[t])}function s(t,n){var l,o,s,c,f=e.useRef({start:null,end:null}),h=u(t),g=e.useCallback((function(){return function(e){var t=e.selectionStart,n=e.selectionEnd;return{start:t,end:n,length:n-t}}(h())}),[h]),v=e.useCallback((function(){return f.current}),[]),d=e.useCallback((function(e){var t=h();t&&a(t)&&(!function(e,t,n){void 0===n&&(n=t),e.setSelectionRange(t,n)}(t,e.start,e.end),f.current=g())}),[h,g]),m=e.useCallback((function(){f.current=g()}),[g]),p=(l=m,o=e.useRef(null),s=e.useCallback((function(){null===o.current&&function e(){l(),o.current=i(e)}()}),[l]),c=e.useCallback((function(){r(o.current),o.current=null}),[]),e.useEffect((function(){o.current&&(c(),s())}),[s,c]),e.useEffect(r,[]),[s,c]),k=p[0],P=p[1];return e.useLayoutEffect((function(){if(n){var e=h();return e.addEventListener("focus",k),e.addEventListener("blur",P),a(e)&&k(),function(){e.removeEventListener("focus",k),e.removeEventListener("blur",P),P()}}})),{getSelection:g,getLastSelection:v,setSelection:d}}function c(t,n){var i=e.useRef(),r=s(i,n),a=r.getSelection,l=r.getLastSelection,o=r.setSelection,c=function(t,n){var i=u(t),r=e.useRef(n);return{getValue:e.useCallback((function(){return i().value}),[i]),getLastValue:e.useCallback((function(){return r.current}),[]),setValue:e.useCallback((function(e){r.current=e;var t=i();t&&(t.value=e)}),[i])}}(i,t),f=c.getValue,h=c.getLastValue,g=c.setValue;return{inputRef:i,getInputState:function(){return{value:f(),selection:a()}},getLastInputState:function(){return{value:h(),selection:l()}},setInputState:function(e){var t=e.value,n=e.selection;g(t),o(n)}}}require("warning");var f=["disabled","onBlur","onChange","onFocus","onMouseDown","readOnly","value"],h={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};var g=function(e){var t=this;this.isCharacterAllowedAtPosition=function(e,n){var i=t.maskOptions.maskPlaceholder;return!!t.isCharacterFillingPosition(e,n)||!!i&&i[n]===e},this.isCharacterFillingPosition=function(e,n){var i=t.maskOptions.mask;if(!e||n>=i.length)return!1;if(!t.isPositionEditable(n))return i[n]===e;var r=i[n];return new RegExp(r).test(e)},this.isPositionEditable=function(e){var n=t.maskOptions,i=n.mask,r=n.permanents;return e<i.length&&-1===r.indexOf(e)},this.isValueEmpty=function(e){return e.split("").every((function(e,n){return!t.isPositionEditable(n)||!t.isCharacterFillingPosition(e,n)}))},this.isValueFilled=function(e){return t.getFilledLength(e)===t.maskOptions.lastEditablePosition+1},this.getDefaultSelectionForValue=function(e){var n=t.getFilledLength(e),i=t.getRightEditablePosition(n);return{start:i,end:i}},this.getFilledLength=function(e){return function(e,t){for(var n=e.length-1;n>=0;n--)if(t(e[n],n))return n;return-1}(e.split(""),(function(e,n){return t.isPositionEditable(n)&&t.isCharacterFillingPosition(e,n)}))+1},this.getStringFillingLengthAtPosition=function(e,n){return e.split("").reduce((function(e,n){return t.insertCharacterAtPosition(e,n,e.length)}),function(e,t){void 0===t&&(t=1);for(var n="",i=0;i<t;i++)n+=e;return n}(" ",n)).length-n},this.getLeftEditablePosition=function(e){for(var n=e;n>=0;n--)if(t.isPositionEditable(n))return n;return null},this.getRightEditablePosition=function(e){for(var n=t.maskOptions.mask,i=e;i<n.length;i++)if(t.isPositionEditable(i))return i;return null},this.formatValue=function(e){var n=t.maskOptions,i=n.maskPlaceholder,r=n.mask;if(!i){for(e=t.insertStringAtPosition("",e,0);e.length<r.length&&!t.isPositionEditable(e.length);)e+=r[e.length];return e}return t.insertStringAtPosition(i,e,0)},this.clearRange=function(e,n,i){if(!i)return e;var r=n+i,a=t.maskOptions,l=a.maskPlaceholder,o=a.mask,u=e.split("").map((function(e,i){var a=t.isPositionEditable(i);return!l&&i>=r&&!a?"":i<n||i>=r?e:a?l?l[i]:"":o[i]})).join("");return t.formatValue(u)},this.insertCharacterAtPosition=function(e,n,i){var r=t.maskOptions,a=r.mask,l=r.maskPlaceholder;if(i>=a.length)return e;var o=t.isCharacterAllowedAtPosition(n,i),u=t.isPositionEditable(i),s=t.getRightEditablePosition(i),c=l&&s?n===l[s]:null,f=e.slice(0,i);!o&&u||(e=f+(o?n:a[i]));return o||u||c||(e=t.insertCharacterAtPosition(e,n,i+1)),e},this.insertStringAtPosition=function(e,n,i){var r=t.maskOptions,a=r.mask,l=r.maskPlaceholder;if(!n||i>=a.length)return e;var o=n.split(""),u=t.isValueFilled(e)||!!l,s=e.slice(i);if(e=o.reduce((function(e,n){return t.insertCharacterAtPosition(e,n,e.length)}),e.slice(0,i)),u)e+=s.slice(e.length-i);else if(t.isValueFilled(e))e+=a.slice(e.length).join("");else{e=s.split("").filter((function(e,n){return t.isPositionEditable(i+n)})).reduce((function(e,n){var i=t.getRightEditablePosition(e.length);return null===i?e:(t.isPositionEditable(e.length)||(e+=a.slice(e.length,i).join("")),t.insertCharacterAtPosition(e,n,e.length))}),e)}return e},this.processChange=function(e,n){var i=t.maskOptions,r=i.mask,a=i.prefix,l=i.lastEditablePosition,o=e.value,u=e.selection,s=n.value,c=n.selection,f=o,h="",g=0,v=0,d=Math.min(c.start,u.start);if(u.end>c.start?(h=f.slice(c.start,u.end),v=(g=t.getStringFillingLengthAtPosition(h,d))?c.length:0):f.length<s.length&&(v=s.length-f.length),f=s,v){if(1===v&&!c.length)d=c.start===u.start?t.getRightEditablePosition(u.start):t.getLeftEditablePosition(u.start);f=t.clearRange(f,d,v)}return f=t.insertStringAtPosition(f,h,d),(d+=g)>=r.length?d=r.length:d<a.length&&!g?d=a.length:d>=a.length&&d<l&&g&&(d=t.getRightEditablePosition(d)),{value:f=t.formatValue(f),enteredString:h,selection:{start:d,end:d}}},this.maskOptions=function(e){var t=e.mask,n=e.maskPlaceholder,i=[];if(!t)return{maskPlaceholder:null,mask:null,prefix:null,lastEditablePosition:null,permanents:[]};if("string"==typeof t){var r=!1,a="";t.split("").forEach((function(e){r||"\\"!==e?(!r&&h[e]||i.push(a.length),a+=e,r=!1):r=!0})),t=a.split("").map((function(e,t){return-1===i.indexOf(t)?h[e]:e}))}else t.forEach((function(e,t){"string"==typeof e&&i.push(t)}));n&&(n=1===n.length?t.map((function(e,t){return-1!==i.indexOf(t)?e:n})):n.split(""),i.forEach((function(e){n[e]=t[e]})),n=n.join(""));for(var l=i.filter((function(e,t){return e===t})).map((function(e){return t[e]})).join(""),o=t.length-1;-1!==i.indexOf(o);)o--;return{maskPlaceholder:n,prefix:l,mask:t,lastEditablePosition:o,permanents:i}}(e)},v=["alwaysShowMask","children","mask","maskPlaceholder","beforeMaskedStateChange"],d=e.forwardRef((function(r,o){var s=r.alwaysShowMask,h=r.children,d=r.mask,m=r.maskPlaceholder,p=r.beforeMaskedStateChange,k=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(r,v);!function(e){var n=e.mask,i=e.maskPlaceholder;n&&i&&1!==i.length&&i.length!==n.length&&t(!1)}(r);var P,b,E=new g({mask:d,maskPlaceholder:m}),S=!!d,C=!k.disabled&&!k.readOnly,w=null!==r.value&&void 0!==r.value,V=(P=S,b=e.useRef(),e.useEffect((function(){b.current=P})),b.current),F=function(e){return""+e}((w?r.value:r.defaultValue)||""),y=c(F,S),O=y.inputRef,L=y.getInputState,A=y.setInputState,R=y.getLastInputState,x=u(O);if(S&&w){var M=x(),D=M&&a(M)||s||r.value?E.formatValue(r.value):r.value;p&&(D=p({nextState:{value:D,selection:{start:null,end:null}}}).value),A(n({},R(),{value:D}))}var j=R(),I=j.selection,q=j.value;e.useLayoutEffect((function(){if(S){var e=x();if(e){var t=a(e),i=I,r=L(),l=n({},r);if(!w){var o=r.value,u=E.formatValue(o),c=E.isValueEmpty(u);!c||t||s?l.value=u:c&&!t&&(l.value="")}t&&!V?l.selection=E.getDefaultSelectionForValue(l.value):w&&t&&i&&null!==i.start&&null!==i.end&&(l.selection=i),p&&(l=p({currentState:r,nextState:l})),A(l)}}}));var B=function(e){O.current=e,!function(e){return"function"==typeof e}(o)?null!==o&&"object"==typeof o&&(o.current=e):o(e)},T=n({},k,{onFocus:function(e){O.current=e.target;var t=L().value;if(S&&!E.isValueFilled(t)){var n=E.formatValue(t),a=E.getDefaultSelectionForValue(n),l={value:n,selection:a};p&&(n=(l=p({currentState:L(),nextState:l})).value,a=l.selection),A(l),n!==t&&r.onChange&&r.onChange(e),i((function(){A(R())}))}r.onFocus&&r.onFocus(e)},onBlur:function(e){var t=L().value,n=R().value;if(S&&!s&&E.isValueEmpty(n)){var i="",a={value:i,selection:{start:null,end:null}};p&&(i=(a=p({currentState:L(),nextState:a})).value),A(a),i!==t&&r.onChange&&r.onChange(e)}r.onBlur&&r.onBlur(e)},onChange:S&&C?function(e){var t=L(),n=R(),i=E.processChange(t,n);p&&(i=p({currentState:t,previousState:n,nextState:i})),A(i),r.onChange&&r.onChange(e)}:r.onChange,onMouseDown:S&&C?function(e){var t=x();if(t){var i=L().value,o=l(t);if(!a(t)&&!E.isValueFilled(i)){var u=e.clientX,s=e.clientY,c=(new Date).getTime();o.addEventListener("mouseup",(function e(i){if(o.removeEventListener("mouseup",e),a(t)){var r=Math.abs(i.clientX-u),l=Math.abs(i.clientY-s),f=Math.max(r,l),h=(new Date).getTime()-c;if(f<=10&&h<=200||f<=5&&h<=300){var g=R(),v=n({},g,{selection:E.getDefaultSelectionForValue(g.value)});A(v)}}}))}r.onMouseDown&&r.onMouseDown(e)}}:r.onMouseDown,value:S&&w?q:r.value});if(h){!function(e,n){f.filter((function(t){return null!=n.props[t]&&n.props[t]!==e[t]})).length&&t(!1)}(r,h);var N=e.Children.only(h);return e.cloneElement(N,n({},T,{ref:B}))}return e.createElement("input",n({ref:B},T))}));d.displayName="InputMask",d.defaultProps={alwaysShowMask:!1,maskPlaceholder:"_"},module.exports=d;
